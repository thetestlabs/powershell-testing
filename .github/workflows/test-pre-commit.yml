name: Test Pre-commit Hooks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC to catch any upstream issues
    - cron: '0 2 * * 0'

jobs:
  test-pre-commit:
    name: Test on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install PowerShell (Linux)
      if: runner.os == 'Linux'
      run: |
        # Install PowerShell on Ubuntu
        wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y powershell
        
    - name: Install PowerShell (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install PowerShell via Homebrew
        brew install --cask powershell
        
        # Try to mitigate assembly loading issues on macOS
        echo "Clearing any existing PowerShell cache..."
        rm -rf ~/.local/share/powershell/Modules/PSScriptAnalyzer 2>/dev/null || true
        rm -rf ~/.cache/powershell 2>/dev/null || true
        
    - name: Verify PowerShell installation
      run: |
        pwsh -Command '$PSVersionTable'
        
    - name: Install PSScriptAnalyzer
      shell: bash
      run: |
        # Install with retry logic and additional error handling for macOS
        if [ "${{ runner.os }}" = "macOS" ]; then
          echo "Installing PSScriptAnalyzer on macOS with workarounds..."
          for i in {1..3}; do
            if pwsh -Command 'Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -Verbose'; then
              echo "PSScriptAnalyzer installed successfully on attempt $i"
              break
            else
              echo "Installation attempt $i failed, retrying..."
              sleep 5
            fi
          done
        else
          pwsh -Command 'Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser'
        fi
        
    - name: Verify PSScriptAnalyzer installation
      shell: bash
      run: |
        # Safe verification with error handling
        echo "Checking PSScriptAnalyzer installation..."
        if pwsh -Command 'try { Get-Module -ListAvailable -Name PSScriptAnalyzer | Select-Object Name, Version, Path } catch { Write-Error "Failed to check PSScriptAnalyzer: $($_.Exception.Message)" }'; then
          echo "PSScriptAnalyzer verification successful"
        else
          echo "PSScriptAnalyzer verification failed, but continuing..."
        fi
        
    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit
        
    - name: Install pre-commit hooks
      run: |
        pre-commit install
        
    - name: Run pre-commit on all files (verbose)
      run: |
        pre-commit run --all-files --verbose
        
    - name: Show pre-commit hook results (if failed)
      if: failure()
      shell: bash
      run: |
        echo "Pre-commit failed. Showing PowerShell and .NET diagnostics:"
        
        # Safe PowerShell version check
        echo "=== PowerShell Version ==="
        if ! pwsh -Command 'try { $PSVersionTable | Format-List } catch { Write-Output "PowerShell diagnostics failed: $($_.Exception.Message)" }'; then
          echo "PowerShell version check failed with assembly loading issues"
        fi
        
        # Safe .NET framework check
        echo "=== .NET Framework ==="
        if ! pwsh -Command 'try { [System.Runtime.InteropServices.RuntimeInformation]::FrameworkDescription } catch { Write-Output ".NET diagnostics failed: $($_.Exception.Message)" }'; then
          echo ".NET framework check failed with assembly loading issues"
        fi
        
        # Safe module check
        echo "=== PSScriptAnalyzer Module ==="
        if ! pwsh -Command 'try { Get-Module -ListAvailable -Name PSScriptAnalyzer } catch { Write-Output "Module check failed: $($_.Exception.Message)" }'; then
          echo "PSScriptAnalyzer module check failed"
        fi
        
        # Show system information for debugging
        echo "=== System Information ==="
        echo "OS: ${{ runner.os }}"
        echo "Architecture: $(uname -m)"
        if [ "${{ runner.os }}" = "macOS" ]; then
          echo "macOS Version: $(sw_vers -productVersion)"
          echo "Xcode Version: $(xcode-select --version 2>/dev/null || echo 'Not installed')"
        fi

  test-hook-isolation:
    name: Test Hook Isolation on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install PowerShell (Linux)
      if: runner.os == 'Linux'
      run: |
        wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y powershell
        
    - name: Install PowerShell (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install --cask powershell
        
    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit
        
    - name: Test individual hooks
      run: |
        # Test PSScriptAnalyzer hook only
        pre-commit run --all-files psscriptanalyzer --verbose
        
        # Test formatter hook only
        pre-commit run --all-files psscriptanalyzer-format --verbose

  report-compatibility:
    name: Compatibility Report
    runs-on: ubuntu-latest
    needs: [test-pre-commit, test-hook-isolation]
    if: always()
    
    steps:
    - name: Generate compatibility report
      shell: bash
      run: |
        echo "## Pre-commit Hook Compatibility Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Main Tests**: ${{ needs.test-pre-commit.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Hook Isolation**: ${{ needs.test-hook-isolation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test-pre-commit.result }}" != "success" ]; then
          echo "⚠️ **Main tests failed** - Check logs for assembly loading or compatibility issues" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test-hook-isolation.result }}" != "success" ]; then
          echo "⚠️ **Hook isolation tests failed** - Individual hooks may have issues" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "If tests fail with assembly loading errors:" >> $GITHUB_STEP_SUMMARY
        echo "1. Check PowerShell and .NET versions" >> $GITHUB_STEP_SUMMARY
        echo "2. Try reinstalling PSScriptAnalyzer" >> $GITHUB_STEP_SUMMARY
        echo "3. Clear PowerShell module cache" >> $GITHUB_STEP_SUMMARY
